<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Anon Chat TMA</title>
  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ viewport: –∑–∞–ø—Ä–µ—â–∞–µ–º –∑—É–º –∏ —É—á–∏—Ç—ã–≤–∞–µ–º safe-area -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <style>
    /* –ë–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #c0e9ff, #e0f7ff);
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
      overflow: hidden;
    }
    /* –£—á–∏—Ç—ã–≤–∞–µ–º safe-area –¥–ª—è iOS */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    #app {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      position: relative;
    }

    /* –†–µ–∂–∏–º –≤–≤–æ–¥–∞: –µ—Å–ª–∏ –∫–ª–∞—Å—Å .input-focused –¥–æ–±–∞–≤–ª–µ–Ω, –º–µ–Ω—è–µ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–≤–æ–¥–∞ */
    #app.input-focused #chatContainer,
    #app.input-focused #profileForm,
    #app.input-focused #partnerInfo {
      display: none;
    }
    #app.input-focused #inputArea {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
    }

    /* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
    #profileForm {
      background: #f0fbff;
      padding: 24px;
      flex-shrink: 0;
    }
    #profileForm h3 {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 700;
      color: #005f99;
    }
    .label {
      display: block;
      font-weight: 600;
      margin: 8px 0 4px;
      font-size: 14px;
      color: #004466;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 2px solid #a4d0ff;
      border-radius: 6px;
      font-size: 14px;
      color: #003355;
      outline: none;
    }
    .form-input:focus {
      border-color: #68b5ff;
    }

    /* –í—ã–±–æ—Ä –ø–æ–ª–∞ ‚Äì —è—Ä–∫–∏–µ –∫–Ω–æ–ø–∫–∏ */
    #genderButtons {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .gender-btn {
      flex: 1;
      padding: 12px 0;
      border-radius: 6px;
      border: 2px solid #89c1ff;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      background: #a4d0ff;
      color: #002244;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .gender-btn.active {
      background: #3596ff;
      border-color: #3596ff;
      color: #fff;
    }

    /* –í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ */
    #interestsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .interest-btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid #a4d0ff;
      background: #d0ecff;
      color: #005280;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    .interest-btn.active {
      background: #3596ff;
      border-color: #3596ff;
      color: #fff;
    }

    /* –ö–Ω–æ–ø–∫–∞ –ù–ê–ß–ê–¢–¨ */
    #startBtn {
      width: 100%;
      padding: 14px;
      background: #3596ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
    }
    #startBtn:hover {
      background: #287acc;
    }

    /* –ß–∞—Ç–æ–≤–∞—è —á–∞—Å—Ç—å */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
    }
    /* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
    #partnerInfo {
      flex-shrink: 0;
      padding: 12px 16px;
      background: #cceeff;
      color: #003355;
      font-weight: 600;
      border-bottom: 2px solid #a4d0ff;
    }
    /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #ebf1f5;
    }
    .system-message {
      text-align: center;
      color: #666;
      font-style: italic;
      margin: 6px 0;
      font-size: 14px;
    }
    .chat-msg {
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .my-message,
    .partner-message {
      max-width: 70%;
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 10px;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }
    .my-message {
      margin-left: auto;
      background: #68b5ff;
      color: #fff;
      margin-right: 6px;
      border-bottom-right-radius: 0;
    }
    .partner-message {
      margin-right: auto;
      background: #fff;
      border: 2px solid #a4d0ff;
      margin-left: 6px;
      border-bottom-left-radius: 0;
    }

    /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º) */
    #inputArea {
      flex-shrink: 0;
      padding: 10px;
      display: flex;
      background: #f0fbff;
      border-top: 2px solid #a4d0ff;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border: 2px solid #a4d0ff;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    #messageInput:focus {
      border-color: #68b5ff;
    }
    #sendBtn {
      background: #68b5ff;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendBtn:hover {
      background: #3596ff;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="profileForm">
    <h3>–ê–ù–û–ù–ò–ú–ù–´–ô –ü–†–û–§–ò–õ–¨</h3>

    <span class="label">–ù–∏–∫ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)</span>
    <input id="nickname" class="form-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫..." autocomplete="off"/>

    <span class="label">–ü–æ–ª</span>
    <div id="genderButtons">
      <button class="gender-btn" data-value="m">üçÜ –ú</button>
      <button class="gender-btn" data-value="f">üçë –ñ</button>
    </div>

    <span class="label">–í–æ–∑—Ä–∞—Å—Ç (—Ü–∏—Ñ—Ä—ã)</span>
    <input id="age" class="form-input" type="number" placeholder="25" inputmode="numeric" pattern="[0-9]*"/>

    <span class="label">–ò–Ω—Ç–µ—Ä–µ—Å—ã</span>
    <div id="interestsContainer">
      <button class="interest-btn" data-value="–§–ª–∏—Ä—Ç">–§–ª–∏—Ä—Ç</button>
      <button class="interest-btn" data-value="–°–µ–∫—Å">–°–µ–∫—Å</button>
      <button class="interest-btn" data-value="–û–±—â–µ–Ω–∏–µ">–û–±—â–µ–Ω–∏–µ</button>
      <button class="interest-btn" data-value="–ò–≥—Ä—ã">–ò–≥—Ä—ã</button>
      <button class="interest-btn" data-value="–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ">–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ</button>
    </div>

    <button id="startBtn">–ù–ê–ß–ê–¢–¨</button>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chatContainer">
    <div id="partnerInfo">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -</div>
    <div id="chat">
      <div class="system-message chat-msg">üëÄ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
    </div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
  const profileForm = document.getElementById('profileForm');
  const nicknameInput = document.getElementById('nickname');
  const ageInput = document.getElementById('age');
  const genderBtns = document.querySelectorAll('.gender-btn');
  let selectedGender = null;
  const interestsContainer = document.getElementById('interestsContainer');
  let selectedInterests = new Set();
  const startBtn = document.getElementById('startBtn');

  const chatContainer = document.getElementById('chatContainer');
  const partnerInfo = document.getElementById('partnerInfo');
  const chat = document.getElementById('chat');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let partnerId = null;

  // –í—ã–±–æ—Ä –ø–æ–ª–∞
  genderBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      genderBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedGender = btn.dataset.value;
    });
  });

  // –í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
  interestsContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('interest-btn')) {
      const val = e.target.dataset.value;
      if (selectedInterests.has(val)) {
        selectedInterests.delete(val);
        e.target.classList.remove('active');
      } else {
        selectedInterests.add(val);
        e.target.classList.add('active');
      }
    }
  });

  // –ö–Ω–æ–ø–∫–∞ "–ù–ê–ß–ê–¢–¨"
  startBtn.addEventListener('click', () => {
    const nickname = nicknameInput.value.trim();
    const ageVal = ageInput.value.trim();

    if (!/^[A-Za-z–ê-–Ø–∞-—è]+$/.test(nickname)) {
      alert('–ù–∏–∫ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã!');
      nicknameInput.focus();
      return;
    }
    if (!/^\d+$/.test(ageVal)) {
      alert('–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º!');
      ageInput.focus();
      return;
    }
    if (!selectedGender) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª!');
      return;
    }
    if (selectedInterests.size === 0) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å!');
      return;
    }

    socket.emit('setProfile', {
      nickname,
      gender: selectedGender,
      age: ageVal,
      interests: Array.from(selectedInterests)
    });

    profileForm.style.display = 'none';
    chatContainer.style.display = 'flex';
    addSystemMessage('üîé –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');

    // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å —Ñ–æ—Ä–º—ã –∏ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å –ø–æ–ª—è –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ 300 –º—Å
    setTimeout(() => { messageInput.focus(); }, 300);
  });

  // –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ —á–∞—Ç –≥–æ—Ç–æ–≤
  socket.on('chatReady', (data) => {
    partnerId = data.partnerId;
    const p = data.partnerProfile || {};
    partnerInfo.innerText = `–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${p.nickname} (${p.gender === 'm' ? '–ú' : '–ñ'}, ${p.age} –ª–µ—Ç)`;
    addSystemMessage('üéâ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ù–∞—á–∏–Ω–∞–π—Ç–µ –æ–±—â–∞—Ç—å—Å—è.');
    setTimeout(() => { messageInput.focus(); }, 300);
  });

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  socket.on('receiveMessage', (msg) => {
    addPartnerMessage(msg.text);
  });

  // –ö–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à—ë–ª
  socket.on('partnerLeft', () => {
    addSystemMessage('‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à—ë–ª.');
    partnerInfo.innerHTML = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -';
    partnerId = null;
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
      messageInput.blur(); // –ü—Ä–∏ –∫–ª–∏–∫–µ Enter —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    }
  });
  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !partnerId) return;
    socket.emit('sendMessage', text);
    addMyMessage(text);
    messageInput.value = '';
    setTimeout(() => { messageInput.focus(); }, 300);
  }

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –ø–æ —á–∞—Ç—É ‚Äì —É–±—Ä–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
  chat.addEventListener('click', () => {
    messageInput.blur();
  });

  // –£—Ç–∏–ª–∏—Ç—ã –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  function addSystemMessage(text) {
    const div = document.createElement('div');
    div.className = 'system-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addMyMessage(text) {
    const div = document.createElement('div');
    div.className = 'my-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addPartnerMessage(text) {
    const div = document.createElement('div');
    div.className = 'partner-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
</script>
</body>
</html>
