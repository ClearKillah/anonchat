<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Anon Chat</title>

  <!-- –ó–∞–ø—Ä–µ—Ç –∑—É–º–∞, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ iPhone 14 Pro -->
  <meta name="viewport"
        content="width=device-width,
                 initial-scale=1.0,
                 maximum-scale=1,
                 user-scalable=no,
                 viewport-fit=cover"/>

  <style>
    /* –°–±—Ä–æ—Å */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #c0e9ff, #e0f7ff);
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω (Mini App) */
    #app {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      max-width: 420px;   /* —á—Ç–æ–±—ã –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –±—ã–ª–æ –Ω–µ —Å—É–ø–µ—Ä—à–∏—Ä–æ–∫–æ */
      margin: 0 auto;
      background: #fff;
    }

    /* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
    #profileForm {
      background: #f0fbff; /* –Ω–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π */
      padding: 24px;
      flex-shrink: 0;
    }
    #profileForm h3 {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 700;
      color: #005f99; /* –±–æ–ª–µ–µ —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π */
    }
    .label {
      display: block;
      font-weight: 600;
      margin: 8px 0 4px;
      color: #004466;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 2px solid #a4d0ff;
      border-radius: 6px;
      font-size: 14px;
      color: #003355;
      outline: none;
    }
    .form-input:focus {
      border-color: #68b5ff;
    }

    /* –ö–Ω–æ–ø–∫–∏ –ø–æ–ª–∞ (–≥–æ–ª—É–±—ã–µ) */
    #genderButtons {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .gender-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      background: #a4d0ff;
      color: #002244;
      border: 2px solid #89c1ff;
      transition: 0.2s ease;
    }
    .gender-btn.active {
      background: #68b5ff;
      border-color: #3596ff;
      color: #fff;
    }

    /* –ò–Ω—Ç–µ—Ä–µ—Å—ã (—è—Ä–∫–∏–µ –≥–æ–ª—É–±—ã–µ) */
    #interestsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .interest-btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      background: #d0ecff;
      color: #005280;
      border: 2px solid #a4d0ff;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .interest-btn.active {
      background: #68b5ff;
      border-color: #3596ff;
      color: #fff;
    }

    #startBtn {
      width: 100%;
      padding: 14px;
      background: #68b5ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }

    /* –ß–∞—Ç */
    #chatContainer {
      flex: 1; /* —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
      display: none; /* —Å–∫—Ä—ã—Ç–æ, –ø–æ–∫–∞ —Ñ–æ—Ä–º–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ */
      flex-direction: column;
      background: #fff;
    }

    /* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
    #partnerInfo {
      flex-shrink: 0;
      padding: 12px 16px;
      background: #cceeff;
      color: #003355;
      font-weight: 600;
      border-bottom: 2px solid #a4d0ff;
    }
    #skipBtn {
      float: right;
      background: #ff8a8a;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      margin-top: -2px;
    }

    /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
    #chat {
      flex: 1;
      overflow-y: auto;
      background: #e6f7ff;
      padding: 10px;
      position: relative; 
    }
    .system-message {
      text-align: center;
      color: #666;
      font-style: italic;
      margin: 6px 0;
    }
    .chat-msg {
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }

    .my-message,
    .partner-message {
      max-width: 70%;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 10px;
      line-height: 1.4;
      word-wrap: break-word;
      font-size: 14px;
    }
    .my-message {
      margin-left: auto;
      margin-right: 6px;
      background: #68b5ff;
      color: #fff;
      border-bottom-right-radius: 0;
    }
    .partner-message {
      margin-left: 6px;
      margin-right: auto;
      background: #fff;
      border: 2px solid #a4d0ff;
      border-bottom-left-radius: 0;
    }

    /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ (flex, —Å–Ω–∏–∑—É) */
    #inputArea {
      flex-shrink: 0;
      padding: 10px;
      display: flex;
      background: #f0fbff;
      border-top: 2px solid #a4d0ff;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border: 2px solid #a4d0ff;
      border-radius: 6px;
      font-size: 14px;
      margin-right: 8px;
      outline: none;
    }
    #messageInput:focus {
      border-color: #68b5ff;
    }
    #sendBtn {
      background: #68b5ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="profileForm">
    <h3>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ü—Ä–æ—Ñ–∏–ª—å (–ì–æ–ª—É–±–æ–π)</h3>

    <span class="label">–ù–∏–∫ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)</span>
    <input id="nickname" class="form-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫..."/>

    <span class="label">–ü–æ–ª</span>
    <div id="genderButtons">
      <button class="gender-btn" data-value="m">–ú (üçÜ)</button>
      <button class="gender-btn" data-value="f">–ñ (üçë)</button>
    </div>

    <span class="label">–í–æ–∑—Ä–∞—Å—Ç (—Ü–∏—Ñ—Ä—ã)</span>
    <input id="age" class="form-input" type="number" placeholder="25" />

    <span class="label">–ò–Ω—Ç–µ—Ä–µ—Å—ã</span>
    <div id="interestsContainer">
      <button class="interest-btn" data-value="–§–ª–∏—Ä—Ç">–§–ª–∏—Ä—Ç</button>
      <button class="interest-btn" data-value="–°–µ–∫—Å">–°–µ–∫—Å</button>
      <button class="interest-btn" data-value="–û–±—â–µ–Ω–∏–µ">–û–±—â–µ–Ω–∏–µ</button>
      <button class="interest-btn" data-value="–ò–≥—Ä—ã">–ò–≥—Ä—ã</button>
      <button class="interest-btn" data-value="–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ">–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ</button>
    </div>

    <button id="startBtn">–ù–ê–ß–ê–¢–¨</button>
  </div>

  <!-- –ß–∞—Ç–æ–≤–∞—è —á–∞—Å—Ç—å -->
  <div id="chatContainer">
    <div id="partnerInfo">
      –°–æ–±–µ—Å–µ–¥–Ω–∏–∫: - 
      <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π</button>
    </div>
    <div id="chat">
      <div class="system-message chat-msg">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
    </div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Socket.io-–∫–ª–∏–µ–Ω—Ç–∞ (–Ω–µ –∑–∞–±—É–¥—å—Ç–µ /socket.io/socket.io.js –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) -->
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
  const profileForm = document.getElementById('profileForm');
  const nicknameInput = document.getElementById('nickname');
  const genderBtns = document.querySelectorAll('.gender-btn');
  let selectedGender = null;

  const ageInput = document.getElementById('age');
  const interestsContainer = document.getElementById('interestsContainer');
  let selectedInterests = new Set();

  const startBtn = document.getElementById('startBtn');

  const chatContainer = document.getElementById('chatContainer');
  const partnerInfo = document.getElementById('partnerInfo');
  const skipBtn = document.getElementById('skipBtn');

  const chat = document.getElementById('chat');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let partnerId = null;

  // –í—ã–±–æ—Ä –ø–æ–ª–∞
  genderBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      genderBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedGender = btn.dataset.value;
    });
  });

  // –í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
  interestsContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('interest-btn')) {
      const val = e.target.dataset.value;
      if (selectedInterests.has(val)) {
        selectedInterests.delete(val);
        e.target.classList.remove('active');
      } else {
        selectedInterests.add(val);
        e.target.classList.add('active');
      }
    }
  });

  // –ö–Ω–æ–ø–∫–∞ –ù–ê–ß–ê–¢–¨
  startBtn.addEventListener('click', () => {
    const nickname = nicknameInput.value.trim();
    const ageVal = ageInput.value.trim();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)
    if (!/^[A-Za-z–ê-–Ø–∞-—è]+$/.test(nickname)) {
      alert('–ù–∏–∫ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã!');
      nicknameInput.focus();
      return;
    }
    // –í–æ–∑—Ä–∞—Å—Ç - —Ü–∏—Ñ—Ä—ã
    if (!/^\d+$/.test(ageVal)) {
      alert('–í–æ–∑—Ä–∞—Å—Ç - —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã!');
      ageInput.focus();
      return;
    }
    // –ü–æ–ª –≤—ã–±—Ä–∞–Ω?
    if (!selectedGender) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª!');
      return;
    }
    // –ò–Ω—Ç–µ—Ä–µ—Å—ã?
    if (selectedInterests.size === 0) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å!');
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    socket.emit('setProfile', {
      nickname,
      gender: selectedGender,
      age: ageVal,
      interests: Array.from(selectedInterests)
    });

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–∞—Ç—É
    profileForm.style.display = 'none';
    chatContainer.style.display = 'flex';
  });

  // –°–µ—Ä–≤–µ—Ä —Å–∫–∞–∑–∞–ª: —á–∞—Ç –≥–æ—Ç–æ–≤
  socket.on('chatReady', (data) => {
    partnerId = data.partnerId;
    const p = data.partnerProfile;
    partnerInfo.innerHTML = `–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${p.nickname} (${p.gender === 'm' ? '–ú' : '–ñ'}, ${p.age}) 
      <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π</button>`;
    // –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å skipBtn?
    document.getElementById('skipBtn').addEventListener('click', skipChat);

    addSystemMessage('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ù–∞—á–∏–Ω–∞–π—Ç–µ –æ–±—â–µ–Ω–∏–µ.');
  });

  // –ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
  socket.on('receiveMessage', (msg) => {
    addPartnerMessage(msg.text);
  });

  // –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à—ë–ª
  socket.on('partnerLeft', () => {
    addSystemMessage('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç.');
    partnerInfo.innerHTML = `–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: - <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π</button>`;
    partnerId = null;
    document.getElementById('skipBtn').addEventListener('click', skipChat);
  });

  // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∏–π"
  skipBtn.addEventListener('click', skipChat);
  function skipChat() {
    socket.emit('skip');
    partnerId = null;
    chat.innerHTML = `<div class="system-message chat-msg">–ò—â–µ–º –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>`;
    partnerInfo.innerHTML = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: - <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π</button>';
    document.getElementById('skipBtn').addEventListener('click', skipChat);
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !partnerId) return;
    socket.emit('sendMessage', text);
    addMyMessage(text);
    messageInput.value = '';
  }

  // –£—Ç–∏–ª–∏—Ç—ã
  function addSystemMessage(text) {
    const div = document.createElement('div');
    div.className = 'system-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addMyMessage(text) {
    const div = document.createElement('div');
    div.className = 'my-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addPartnerMessage(text) {
    const div = document.createElement('div');
    div.className = 'partner-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
</script>
</body>
</html>
