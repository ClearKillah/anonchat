<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Anon Chat</title>
  <!-- Адаптивная верстка для мобильных -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Сброс стилей */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: #333;
    }

    /* Форма профиля */
    #profileForm {
      padding: 20px;
      background: #fff;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    #profileForm h3 {
      margin-top: 0;
    }
    #profileForm label {
      font-weight: bold;
    }
    #profileForm input,
    #profileForm select {
      width: 100%;
      margin: 5px 0 15px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #profileForm button {
      padding: 10px 20px;
      background: #2a9df4;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #profileForm button:hover {
      background: #238ad3;
    }

    /* Контейнер чата */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      display: none; /* скрыт до входа */
    }
    /* Верхняя панель */
    #partnerInfo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      padding: 10px 20px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      font-weight: bold;
    }
    #skipBtn {
      background: #ff5c5c;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
    }
    #skipBtn:hover {
      background: #d94a4a;
    }

    /* Окно сообщений */
    #chat {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5ddd5;
    }
    .system-message {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 10px 0;
      font-style: italic;
    }
    .my-message,
    .partner-message {
      max-width: 60%;
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 8px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .my-message {
      margin-left: auto;
      background: #b2f1ff; /* голубой */
      text-align: left;
      margin-right: 10px;
      border-bottom-right-radius: 0;
    }
    .partner-message {
      margin-right: auto;
      background: #fff;
      text-align: left;
      margin-left: 10px;
      border-bottom-left-radius: 0;
    }
    .media-thumb {
      max-width: 200px;
      display: block;
      margin: 5px 0;
    }

    /* Поле ввода + кнопки */
    #inputArea {
      display: flex;
      align-items: center;
      background: #fff;
      padding: 8px;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 8px;
    }
    #sendBtn, #uploadBtn {
      background: #2a9df4;
      color: #fff;
      border: none;
      padding: 10px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
    }
    #sendBtn:hover, #uploadBtn:hover {
      background: #238ad3;
    }

    /* Адаптивность */
    @media (max-width: 600px) {
      .my-message, .partner-message {
        max-width: 80%;
        font-size: 15px;
      }
      #profileForm {
        padding: 10px;
      }
      #inputArea {
        flex-direction: row;
      }
      #messageInput {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>

  <!-- Форма профиля -->
  <div id="profileForm">
    <h3>Анонимный профиль</h3>
    <label for="nickname">Ник (только буквы)</label>
    <input type="text" id="nickname" placeholder="Введите ник" />

    <label for="gender">Пол</label>
    <select id="gender">
      <option value="m">Мужской</option>
      <option value="f">Женский</option>
    </select>

    <label for="age">Возраст (только цифры)</label>
    <input type="text" id="age" placeholder="Например, 25" />

    <button id="saveProfileBtn">Начать</button>
  </div>

  <!-- Чат -->
  <div id="chatContainer">
    <div id="partnerInfo">
      <span id="partnerLabel">Собеседник: -</span>
      <button id="skipBtn">Следующий</button>
    </div>
    <div id="chat">
      <div class="system-message">Ожидание собеседника...</div>
    </div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Введите сообщение..." />
      <button id="sendBtn">Отправить</button>
      <button id="uploadBtn">Файл</button>
      <input type="file" id="fileInput" style="display: none;" />
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // DOM-элементы
    const profileForm = document.getElementById('profileForm');
    const nicknameInput = document.getElementById('nickname');
    const genderSelect = document.getElementById('gender');
    const ageInput = document.getElementById('age');
    const saveProfileBtn = document.getElementById('saveProfileBtn');

    const chatContainer = document.getElementById('chatContainer');
    const chat = document.getElementById('chat');
    const partnerLabel = document.getElementById('partnerLabel');
    const skipBtn = document.getElementById('skipBtn');

    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');

    let partnerId = null;

    // 1. Сохранение профиля с валидацией
    saveProfileBtn.addEventListener('click', () => {
      const nickname = nicknameInput.value.trim();
      const gender = genderSelect.value;
      const age = ageInput.value.trim();

      // Валидация ника (только буквы)
      if (!/^[A-Za-zА-Яа-я]+$/.test(nickname)) {
        alert('Ник может содержать только буквы (без цифр и символов).');
        return;
      }

      // Валидация возраста (только цифры)
      if (!/^\d+$/.test(age)) {
        alert('Возраст должен содержать только цифры.');
        return;
      }

      if (!nickname || !age) {
        alert('Заполните ник и возраст!');
        return;
      }

      socket.emit('setProfile', { nickname, gender, age });
      profileForm.style.display = 'none';
      chatContainer.style.display = 'flex';
      addSystemMessage('Ищем собеседника...');
    });

    // 2. Когда сервер сообщает, что чат готов
    socket.on('chatReady', (data) => {
      partnerId = data.partnerId;
      const p = data.partnerProfile;
      partnerLabel.innerText = `Собеседник: ${p.nickname} (${p.gender === 'm' ? 'М' : 'Ж'}, ${p.age})`;
      addSystemMessage('Собеседник найден! Можете общаться.');
    });

    // 3. Пришло сообщение
    socket.on('receiveMessage', (msg) => {
      addPartnerMessage(msg.text);
    });

    // 4. Пришло медиа
    socket.on('receiveMedia', (data) => {
      const { fileUrl } = data;
      addPartnerMedia(fileUrl);
    });

    // 5. Собеседник покинул чат
    socket.on('partnerLeft', () => {
      addSystemMessage('Собеседник вышел. Нажмите «Следующий» или обновите страницу.');
      partnerLabel.innerText = 'Собеседник: -';
      partnerId = null;
    });

    // 6. Отправка сообщения
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !partnerId) return;
      socket.emit('sendMessage', text);
      addMyMessage(text);
      messageInput.value = '';
    }

    // 7. «Следующий»
    skipBtn.addEventListener('click', () => {
      socket.emit('skip');
      partnerId = null;
      partnerLabel.innerText = 'Собеседник: -';
      chat.innerHTML = '';
      addSystemMessage('Ищем нового собеседника...');
    });

    // 8. Отправка файлов
    uploadBtn.addEventListener('click', () => {
      fileInput.click(); // откроем диалог выбора файла
    });

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file || !partnerId) return;

      // Отправим на сервер через fetch POST /upload
      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.fileUrl) {
          // Отправим socket-событие партнеру
          socket.emit('sendMedia', data.fileUrl);
          // Добавим в свой чат
          addMyMedia(data.fileUrl);
        }
      } catch (err) {
        console.error('Upload error:', err);
      }

      fileInput.value = ''; // сбросим инпут
    });

    // -- Утилиты вывода сообщений --

    function addMyMessage(text) {
      const div = document.createElement('div');
      div.className = 'my-message';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addPartnerMessage(text) {
      const div = document.createElement('div');
      div.className = 'partner-message';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // Отображение собственного медиа
    function addMyMedia(url) {
      const div = document.createElement('div');
      div.className = 'my-message';
      div.innerHTML = renderMedia(url);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // Отображение медиа от собеседника
    function addPartnerMedia(url) {
      const div = document.createElement('div');
      div.className = 'partner-message';
      div.innerHTML = renderMedia(url);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // В зависимости от типа файла показываем картинку или ссылку
    function renderMedia(url) {
      // Можем по расширению/контент-типу определять, картинка ли это
      const lower = url.toLowerCase();
      if (lower.endsWith('.png') || lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.gif')) {
        return `<img src="${url}" class="media-thumb" alt="image" />`;
      } else if (lower.endsWith('.mp4') || lower.endsWith('.webm') || lower.endsWith('.mov')) {
        return `<video src="${url}" class="media-thumb" controls></video>`;
      } else if (lower.endsWith('.mp3') || lower.endsWith('.wav') || lower.endsWith('.ogg')) {
        return `<audio src="${url}" class="media-thumb" controls></audio>`;
      } else {
        // Прочие форматы - просто ссылка
        return `<a href="${url}" target="_blank">Скачать файл</a>`;
      }
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'system-message';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
