<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>Anon Chat TMA</title>

  <!-- –ó–∞–ø—Ä–µ—Ç –∑—É–º–∞ –∏ –∞–¥–∞–ø—Ç–∏–≤ –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0,
                 user-scalable=no, maximum-scale=1,
                 viewport-fit=cover" />

  <style>
    /* –°–±—Ä–æ—Å –∏ –∑–∞–ø—Ä–µ—Ç —Å–∫—Ä–æ–ª–ª–∞/–≤—ã–¥–µ–ª–µ–Ω–∏—è */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
      -webkit-touch-callout: none; /* iOS longpress disable? */
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden; /* –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —Å–∫—Ä–æ–ª–ª—ã */
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f0f0f0, #ffffff);
      color: #333;
      /* –±–µ–∑ —Å–∫—Ä–æ–ª–ª-–±–∞—Ä–∞ */
    }
    /* Safe area insets –¥–ª—è iOS */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    #appWrapper {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä */
    @media (min-width: 500px) {
      #appWrapper {
        width: 420px;
        height: 700px;
        margin: auto;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      }
    }

    /* –§–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è */
    #profileForm {
      background: linear-gradient(135deg, #fafafa, #ececec);
      flex-shrink: 0;
      padding: 24px;
    }
    #profileForm h3 {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 700;
    }
    .label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    /* –í—ã–±–æ—Ä –ø–æ–ª–∞ (–∫—Ä—É–ø–Ω—ã–µ —è—Ä–∫–∏–µ –∫–Ω–æ–ø–∫–∏) */
    #genderButtons {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .gender-btn {
      flex: 1;
      padding: 12px 0;
      border-radius: 8px;
      border: 2px solid #ccc;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      transition: 0.2s ease all;
      background: #eee;
      color: #555;
    }
    .gender-btn:hover {
      background: #ddd;
    }
    .gender-btn.active {
      background: #ff5454;
      border-color: #ff2b2b;
      color: #fff;
    }
    .female-btn.active {
      background: #ff64d9;
      border-color: #ff27c8;
      color: #fff;
    }

    /* –ò–Ω—Ç–µ—Ä–µ—Å—ã */
    #interestsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .interest-btn {
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      border: 2px solid #ccc;
      background: #fafafa;
      color: #444;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .interest-btn:hover {
      background: #eee;
    }
    .interest-btn.active {
      background: #4edc7a;
      border-color: #2bbf58;
      color: #fff;
    }

    /* –ö–Ω–æ–ø–∫–∞ –ù–ê–ß–ê–¢–¨ */
    #startBtn {
      display: block;
      width: 100%;
      margin-top: 8px;
      padding: 14px;
      background: #47c757;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #startBtn:hover {
      background: #39ab4a;
    }

    /* –ß–∞—Ç-—ç–∫—Ä–∞–Ω */
    #chatContainer {
      flex: 1;
      background: #fff;
      display: none;
      flex-direction: column;
    }

    #partnerInfo {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f7f7f7;
      border-bottom: 1px solid #ddd;
      padding: 12px 16px;
      font-weight: 600;
      flex-shrink: 0;
    }
    #skipBtn {
      background: #ff7878;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      transition: 0.2s ease;
    }
    #skipBtn:hover {
      background: #ff5050;
    }

    /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
    #chat {
      flex: 1;
      background: #ebf1f5;
      padding: 12px;
      overflow-y: auto;
    }
    .system-message {
      text-align: center;
      color: #666;
      font-style: italic;
      margin: 6px 0;
    }
    .chat-msg {
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1;}
    }
    .my-message,
    .partner-message {
      max-width: 70%;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 12px;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }
    .my-message {
      background: #6ddb91;
      color: #fff;
      margin-left: auto;
      margin-right: 8px;
      border-bottom-right-radius: 0;
    }
    .partner-message {
      background: #fff;
      border: 1px solid #ddd;
      margin-left: 8px;
      margin-right: auto;
      border-bottom-left-radius: 0;
    }

    /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
    #inputArea {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      padding: 8px;
      border-top: 1px solid #ddd;
      background: #f7f7f7;
    }
    #messageInput {
      flex: 1;
      font-size: 14px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-right: 8px;
      outline: none;
    }
    #sendBtn {
      background: #47c757;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }
    #sendBtn:hover {
      background: #39ab4a;
    }
  </style>
</head>
<body>

<div id="appWrapper">
  <!-- –§–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
  <div id="profileForm">
    <h3>–ê–ù–û–ù–ò–ú–ù–´–ô –ü–†–û–§–ò–õ–¨</h3>

    <span class="label">–ù–∏–∫ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)</span>
    <input id="nickname" class="form-input" type="text"
           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫..." autocomplete="off"/>

    <span class="label">–ü–æ–ª</span>
    <div id="genderButtons">
      <button class="gender-btn" data-value="m">üçÜ –ú</button>
      <button class="gender-btn" data-value="f">üçë –ñ</button>
    </div>

    <span class="label">–í–æ–∑—Ä–∞—Å—Ç (—Ü–∏—Ñ—Ä—ã)</span>
    <input id="age" class="form-input" type="number"
           placeholder="25"
           inputmode="numeric"
           pattern="[0-9]*"/>

    <span class="label">–ò–Ω—Ç–µ—Ä–µ—Å—ã</span>
    <div id="interestsContainer">
      <button class="interest-btn" data-value="–§–ª–∏—Ä—Ç">–§–ª–∏—Ä—Ç</button>
      <button class="interest-btn" data-value="–°–µ–∫—Å">–°–µ–∫—Å</button>
      <button class="interest-btn" data-value="–û–±—â–µ–Ω–∏–µ">–û–±—â–µ–Ω–∏–µ</button>
      <button class="interest-btn" data-value="–ò–≥—Ä—ã">–ò–≥—Ä—ã</button>
      <button class="interest-btn" data-value="–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ">–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ</button>
    </div>

    <button id="startBtn">–ù–ê–ß–ê–¢–¨</button>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chatContainer">
    <div id="partnerInfo">
      <span id="partnerLabel">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -</span>
      <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π ü§ù</button>
    </div>
    <div id="chat">
      <div class="system-message chat-msg">üëÄ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
    </div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const profileForm = document.getElementById('profileForm');
  const nicknameInput = document.getElementById('nickname');
  const genderBtns = document.querySelectorAll('.gender-btn');
  let selectedGender = null;

  const ageInput = document.getElementById('age');
  const interestsContainer = document.getElementById('interestsContainer');
  let selectedInterests = new Set();

  const startBtn = document.getElementById('startBtn');

  const chatContainer = document.getElementById('chatContainer');
  const partnerLabel = document.getElementById('partnerLabel');
  const skipBtn = document.getElementById('skipBtn');

  const chat = document.getElementById('chat');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let partnerId = null;

  // –í—ã–±–æ—Ä –ø–æ–ª–∞
  genderBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // —Å–Ω–∏–º–∞–µ–º active —Å–æ –≤—Å–µ—Ö
      genderBtns.forEach(b => b.classList.remove('active'));
      // —Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â–µ–π
      btn.classList.add('active');
      selectedGender = btn.dataset.value; // 'm' –∏–ª–∏ 'f'
    });
  });

  // –í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
  interestsContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('interest-btn')) {
      const val = e.target.dataset.value;
      if (selectedInterests.has(val)) {
        selectedInterests.delete(val);
        e.target.classList.remove('active');
      } else {
        selectedInterests.add(val);
        e.target.classList.add('active');
      }
    }
  });

  // –ö–Ω–æ–ø–∫–∞ "–ù–ê–ß–ê–¢–¨"
  startBtn.addEventListener('click', () => {
    const nickname = nicknameInput.value.trim();
    const age = ageInput.value.trim();

    if (!/^[A-Za-z–ê-–Ø–∞-—è]+$/.test(nickname)) {
      alert('–ù–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã!');
      return;
    }
    if (!/^\d+$/.test(age)) {
      alert('–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º!');
      return;
    }
    if (!selectedGender) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª!');
      return;
    }
    if (selectedInterests.size === 0) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å!');
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    socket.emit('setProfile', {
      nickname,
      gender: selectedGender,
      age,
      interests: Array.from(selectedInterests)
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
    profileForm.style.display = 'none';
    chatContainer.style.display = 'flex';
    addSystemMessage('üîé –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ
    setTimeout(() => {
      messageInput.focus();
    }, 300);
  });

  // –ö–æ–≥–¥–∞ —á–∞—Ç –≥–æ—Ç–æ–≤
  socket.on('chatReady', (data) => {
    partnerId = data.partnerId;
    const p = data.partnerProfile || {};
    partnerLabel.innerText = `–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${p.nickname} (${p.gender === 'm' ? '–ú' : '–ñ'}, ${p.age})`;
    addSystemMessage('üéâ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ù–∞—á–∏–Ω–∞–π—Ç–µ –æ–±—â–∞—Ç—å—Å—è.');
    setTimeout(() => {
      messageInput.focus();
    }, 300);
  });

  // –ü—Ä–∏—Ö–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
  socket.on('receiveMessage', (msg) => {
    addPartnerMessage(msg.text);
  });

  // –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—à–µ–ª
  socket.on('partnerLeft', () => {
    addSystemMessage('‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—à–µ–ª. –ù–∞–∂–º–∏—Ç–µ ¬´–°–ª–µ–¥—É—é—â–∏–π¬ª');
    partnerLabel.innerText = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -';
    partnerId = null;
  });

  // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∏–π"
  skipBtn.addEventListener('click', () => {
    socket.emit('skip');
    partnerId = null;
    partnerLabel.innerText = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -';
    chat.innerHTML = '';
    addSystemMessage('üîé –ò—â–µ–º –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
    setTimeout(() => messageInput.focus(), 300);
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !partnerId) return;
    socket.emit('sendMessage', text);
    addMyMessage(text);
    messageInput.value = '';
    messageInput.blur();
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å
    setTimeout(() => {
      messageInput.focus();
      // –ü–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å
      chat.scrollTop = chat.scrollHeight;
    }, 300);
  }

  // –£—Ç–∏–ª–∏—Ç—ã –≤—ã–≤–æ–¥–∞
  function addMyMessage(text) {
    const div = document.createElement('div');
    div.className = 'my-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addPartnerMessage(text) {
    const div = document.createElement('div');
    div.className = 'partner-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function addSystemMessage(text) {
    const div = document.createElement('div');
    div.className = 'system-message chat-msg';
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ (–∏–ª–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
  window.addEventListener('resize', () => {
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ—Å—å
    chat.scrollTop = chat.scrollHeight;
  });
</script>

</body>
</html>
