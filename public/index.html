<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Anon Chat Fresh</title>

  <!-- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –¥–ª—è iOS –≤–∞–∂–Ω–æ "viewport-fit=cover" -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <style>
    /* –°–±—Ä–æ—Å */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #CDE6FE, #DEF7FE);
      color: #333;
      -webkit-user-select: none; /* —á—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ –≤—ã–¥–µ–ª—è—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
      user-select: none;
      overscroll-behavior: none;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    #mainWrapper {
      width: 422px;
      height: 625px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      margin: auto;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –º–µ–Ω—å—à–µ 422x625, —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ 100% */
    @media (max-width: 422px) {
      #mainWrapper {
        width: 100%;
        height: 100%;
        border-radius: 0;
      }
    }
    @media (max-height: 625px) {
      #mainWrapper {
        height: 100%;
      }
    }

    /* –§–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è */
    #profileForm {
      padding: 16px;
      background: linear-gradient(135deg, #F7F7F7, #EFEFEF);
      box-shadow: inset 0 -1px 1px rgba(0,0,0,0.05);
      flex-shrink: 0;
    }
    #profileForm h3 {
      margin-bottom: 12px;
      font-weight: 600;
      color: #444;
      font-size: 16px;
    }
    #profileForm .label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }
    #profileForm input {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    /* –í—ã–±–æ—Ä –ø–æ–ª–∞ –∫–Ω–æ–ø–∫–∞–º–∏ */
    #genderButtons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .gender-btn {
      flex: 1;
      padding: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s ease;
    }
    .gender-btn.active {
      background: #a6e4bb;
      border-color: #70c16d;
      color: #fff;
    }
    .male-btn {
      background: #93d0f3;
      border-color: #61b8ee;
      color: #fff;
    }
    .male-btn.active {
      background: #61b8ee;
    }
    .female-btn {
      background: #f7b8d9;
      border-color: #f38cbf;
      color: #fff;
    }
    .female-btn.active {
      background: #f38cbf;
    }

    /* –ö–Ω–æ–ø–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ */
    #interestsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }
    .interest-btn {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #fff;
      color: #666;
      font-size: 12px;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .interest-btn.active {
      background: #5fd39f;
      border-color: #4db681;
      color: #fff;
    }

    /* –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å" */
    #profileForm button {
      display: inline-block;
      background: #87d37c;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #profileForm button:hover {
      background: #70c16d;
    }

    /* –ß–∞—Ç-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #chatContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      background: #fff;
      position: relative;
    }
    #partnerInfo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #F2F2F2, #F9F9F9);
      padding: 12px 16px;
      box-shadow: inset 0 -1px 1px rgba(0,0,0,0.05);
      font-weight: 600;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }
    #skipBtn {
      background: #f76c6c;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      transition: background 0.2s ease;
    }
    #skipBtn:hover {
      background: #ef5a5a;
    }

    /* –ß–∞—Ç-–æ–∫–Ω–æ */
    #chat {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #ebf1f5;
      display: flex;
      flex-direction: column;
    }
    .system-message {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 10px 0;
      font-style: italic;
    }
    .chat-msg {
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .my-message,
    .partner-message {
      max-width: 70%;
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 12px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .my-message {
      margin-left: auto;
      background: linear-gradient(135deg, #a6e4bb, #5fd39f);
      color: #fff;
      margin-right: 8px;
      border-bottom-right-radius: 0;
    }
    .partner-message {
      margin-right: auto;
      background: #fff;
      margin-left: 8px;
      border: 1px solid #ddd;
      border-bottom-left-radius: 0;
    }

    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
    #inputArea {
      display: flex;
      align-items: center;
      padding: 8px;
      border-top: 1px solid #eee;
      background: linear-gradient(135deg, #F2F2F2, #FBFBFB);
      flex-shrink: 0;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 8px;
    }
    #sendBtn {
      background: #87d37c;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    #sendBtn:hover {
      background: #70c16d;
    }

  </style>
</head>
<body>
  <div id="mainWrapper">
    <!-- –§–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileForm">
      <h3>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å üöÄ</h3>

      <span class="label">–ù–∏–∫ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)</span>
      <input
        type="text"
        id="nickname"
        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫..."
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
      />

      <span class="label">–ü–æ–ª</span>
      <div id="genderButtons">
        <button class="gender-btn male-btn" data-value="m">üçÜ –ú</button>
        <button class="gender-btn female-btn" data-value="f">üçë –ñ</button>
      </div>

      <span class="label">–í–æ–∑—Ä–∞—Å—Ç (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)</span>
      <!-- numeric keyboard hint -->
      <input
        id="age"
        type="number"
        placeholder="25"
        inputmode="numeric"
        pattern="[0-9]*"
      />

      <span class="label">–ò–Ω—Ç–µ—Ä–µ—Å—ã</span>
      <div id="interestsContainer">
        <button class="interest-btn" data-value="–§–ª–∏—Ä—Ç">–§–ª–∏—Ä—Ç</button>
        <button class="interest-btn" data-value="–°–µ–∫—Å">–°–µ–∫—Å</button>
        <button class="interest-btn" data-value="–û–±—â–µ–Ω–∏–µ">–û–±—â–µ–Ω–∏–µ</button>
        <button class="interest-btn" data-value="–ò–≥—Ä—ã">–ò–≥—Ä—ã</button>
        <button class="interest-btn" data-value="–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ">–û–±–æ—Å—Å–∞—Ç—å –≤ —Ç–æ–ª—á–∫–µ</button>
      </div>

      <button id="saveProfileBtn">–ù–∞—á–∞—Ç—å</button>
    </div>

    <!-- –ß–∞—Ç -->
    <div id="chatContainer">
      <div id="partnerInfo">
        <span id="partnerLabel">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -</span>
        <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π ü§ù</button>
      </div>
      <div id="chat">
        <div class="system-message chat-msg">üëÄ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
      </div>
      <div id="inputArea">
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const mainWrapper = document.getElementById('mainWrapper');
    const profileForm = document.getElementById('profileForm');
    const nicknameInput = document.getElementById('nickname');
    const genderButtons = document.querySelectorAll('.gender-btn');
    let selectedGender = null;

    const ageInput = document.getElementById('age');
    const interestsContainer = document.getElementById('interestsContainer');
    const saveProfileBtn = document.getElementById('saveProfileBtn');

    const chatContainer = document.getElementById('chatContainer');
    const chat = document.getElementById('chat');
    const partnerLabel = document.getElementById('partnerLabel');
    const skipBtn = document.getElementById('skipBtn');

    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    let partnerId = null;
    let selectedInterests = new Set(); // —Ö—Ä–∞–Ω–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º –ø–æ–ª–∞
    genderButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö
        genderButtons.forEach(b => b.classList.remove('active'));
        // –°—Ç–∞–≤–∏–º active –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é
        btn.classList.add('active');
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        selectedGender = btn.dataset.value; // 'm' –∏–ª–∏ 'f'
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
    interestsContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('interest-btn')) {
        const val = e.target.dataset.value; // –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞
        if (selectedInterests.has(val)) {
          // –°–Ω–∏–º–µ–º –≤—ã–±–æ—Ä
          selectedInterests.delete(val);
          e.target.classList.remove('active');
        } else {
          // –î–æ–±–∞–≤–∏–º –≤—ã–±–æ—Ä
          selectedInterests.add(val);
          e.target.classList.add('active');
        }
      }
    });

    // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å"
    saveProfileBtn.addEventListener('click', () => {
      const nickname = nicknameInput.value.trim();
      const gender = selectedGender; // 'm' –∏–ª–∏ 'f'
      const age = ageInput.value.trim();

      // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã)
      if (!/^[A-Za-z–ê-–Ø–∞-—è]+$/.test(nickname)) {
        alert('–ù–∏–∫ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã (–±–µ–∑ —Ü–∏—Ñ—Ä –∏ —Å–∏–º–≤–æ–ª–æ–≤).');
        return;
      }
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
      if (!/^\d+$/.test(age)) {
        alert('–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.');
        return;
      }
      if (!nickname || !age) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∏–∫ –∏ –≤–æ–∑—Ä–∞—Å—Ç!');
        return;
      }
      if (!gender) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª!');
        return;
      }
      if (selectedInterests.size === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å!');
        return;
      }

      // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤ –º–∞—Å—Å–∏–≤
      const interestsArray = Array.from(selectedInterests);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      socket.emit('setProfile', {
        nickname,
        gender,
        age,
        interests: interestsArray
      });

      profileForm.style.display = 'none';
      chatContainer.style.display = 'flex';
      addSystemMessage('üîé –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
    });

    // –ö–æ–≥–¥–∞ —á–∞—Ç –≥–æ—Ç–æ–≤
    socket.on('chatReady', (data) => {
      partnerId = data.partnerId;
      const p = data.partnerProfile;
      partnerLabel.innerText = `–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${p.nickname} (${p.gender === 'm' ? '–ú' : '–ñ'}, ${p.age})`;
      addSystemMessage('üéâ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ù–∞—á–∏–Ω–∞–π—Ç–µ –æ–±—â–∞—Ç—å—Å—è.');
    });

    // –ü—Ä–∏—Ö–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
    socket.on('receiveMessage', (msg) => {
      addPartnerMessage(msg.text);
    });

    // –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à—ë–ª
    socket.on('partnerLeft', () => {
      addSystemMessage('‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—à–µ–ª. –ù–∞–∂–º–∏—Ç–µ ¬´–°–ª–µ–¥—É—é—â–∏–π¬ª –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      partnerLabel.innerText = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -';
      partnerId = null;
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !partnerId) return;
      socket.emit('sendMessage', text);
      addMyMessage(text);
      messageInput.value = '';
      messageInput.blur(); // —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
    }

    // –°–ª–µ–¥—É—é—â–∏–π
    skipBtn.addEventListener('click', () => {
      socket.emit('skip');
      partnerId = null;
      partnerLabel.innerText = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: -';
      chat.innerHTML = '';
      addSystemMessage('üîé –ò—â–µ–º –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
    });

    // –£—Ç–∏–ª–∏—Ç—ã –≤—ã–≤–æ–¥–∞
    function addMyMessage(text) {
      const div = document.createElement('div');
      div.className = 'my-message chat-msg';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function addPartnerMessage(text) {
      const div = document.createElement('div');
      div.className = 'partner-message chat-msg';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'system-message chat-msg';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
